<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Galaxy Education</title>
    <style>
        :root {
            --primary-bg: #222831;
            --glass-bg: rgba(49, 54, 63, 0.92);
            --accent: #98CD00;
            --accent2: #98CD00;
            --text: #EEEEEE;
            --muted: #b0b3c6;
            --shadow: 0 2px 8px 0 rgba(49, 54, 63, 0.18);
            --radius: 18px;
            --blur: 6px;
            --transition: 0.3s cubic-bezier(.4,2,.3,1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #222831 0%, #31363F 100%);
            color: var(--text);
            min-height: 100vh;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--glass-bg);
            box-shadow: var(--shadow);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(var(--blur));
        }
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            letter-spacing: 2px;
            text-shadow: 0 2px 8px var(--accent2);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text);
        }
        .sign-out-btn {
            padding: 0.5rem 1.2rem;
            background: var(--accent);
            border: 1px solid var(--accent2);
            color: #222831;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background var(--transition), color var(--transition), box-shadow var(--transition);
            box-shadow: 0 4px 20px var(--accent2);
        }
        .sign-out-btn:hover {
            background: #EEEEEE;
            color: #222831;
            box-shadow: 0 8px 32px var(--accent2);
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 5rem auto;
            padding: 0 1rem;
            z-index: 0;
        }
        .dashboard-header {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            color: var(--accent);
            box-shadow: var(--shadow);
        }
        .dashboard-header h1 {
            margin-bottom: 1rem;
            color: var(--accent);
            text-shadow: 0 2px 8px var(--accent2);
        }
        .dashboard-header p {
            color: var(--muted);
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }
        .dashboard-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            padding: 2rem 1.2rem;
            border-radius: var(--radius);
            color: var(--text);
            box-shadow: var(--shadow);
            transition: transform var(--transition), box-shadow var(--transition);
        }
        .dashboard-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 40px var(--accent2);
        }
        .dashboard-card h2 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
            color: var(--accent);
            text-shadow: 0 2px 8px var(--accent2);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px var(--accent2);
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--accent);
            text-shadow: 0 2px 8px var(--accent2);
        }
        .stat-label {
            font-size: 0.95rem;
            color: var(--muted);
        }
        .recent-activity {
            margin-top: 2rem;
        }
        .activity-list {
            list-style: none;
            padding: 0;
        }
        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            background: var(--glass-bg);
            border-radius: var(--radius);
            margin-bottom: 0.7rem;
            color: var(--text);
            box-shadow: 0 2px 8px var(--accent2);
            transition: background var(--transition);
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-time {
            font-size: 0.85rem;
            color: var(--accent);
        }
        .nav-links a:hover {
            color: var(--accent2);
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            top: 20px;
            right: 0;
            background: var(--glass-bg);
            min-width: 160px;
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(var(--blur));
            overflow: hidden;
        }
        .dropdown-content a {
            color: var(--text);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background var(--transition), color var(--transition);
        }
        .dropdown-content a:hover {
            background: var(--accent);
            color: #222831;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .dropdown:hover .user-email {
            color: var(--accent2);
        }
        .user-icon {
            color: var(--accent);
            box-shadow: 0 2px 8px var(--accent);
        }
        .logo, .dashboard-header h1, .dashboard-card h2, .stat-value, .user-icon {
            color: var(--accent) !important;
            text-shadow: none !important;
        }
        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-header h1 {
                font-size: 1.7rem;
            }
            .dashboard-header {
                padding: 1.2rem;
            }
        }
        @media (max-width: 600px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 0.5rem;
            }
            .dashboard-container {
                margin: 2rem 0.2rem;
                padding: 0 0.2rem;
            }
            .dashboard-header {
                padding: 1rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><a href="index.html">MrJ</a></div>
        <div class="user-info">
            <div class="nav-links">
                <div class="dropdown">
                    <a href="#" class="user-email"></a>
                    <div class="dropdown-content">
                        <a href="index.html">Home</a>
                        <a href="dashboard.html">Dashboard</a>
                    </div>
                </div>
                <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Welcome to Your Dashboard</h1>
            <p>Manage your ratings and view your activity</p>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h2>Your Statistics</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalRatings">0</div>
                        <div class="stat-label">Total Ratings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="averageRating">0</div>
                        <div class="stat-label">Average Rating</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <h2>Recent Activity</h2>
                <div class="recent-activity">
                    <ul class="activity-list" id="activityList">
                        <!-- Activity items will be added here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
        
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/ratings.js"></script>
    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            // Initialize dashboard
            const dashboard = new Dashboard(session.user);
            await dashboard.init();

            // Add sign out handler
            document.getElementById('signOutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                await dashboard.signOut();
            });
        });

        class Dashboard {
            constructor(user) {
                this.user = user;
                this.userEmail = document.querySelector('.user-email');
                this.totalRatingsEl = document.getElementById('totalRatings');
                this.averageRatingEl = document.getElementById('averageRating');
                this.activityListEl = document.getElementById('activityList');
            }

            async init() {
                this.userEmail.textContent = this.user.email;
                await this.loadUserStats();
                await this.loadRecentActivity();
                this.setupRealtimeSubscription();
            }

            async loadUserStats() {
                try {
                    const { data: ratings, error } = await supabase
                        .from('ratings')
                        .select('rating')
                        .eq('user_id', this.user.id);

                    if (error) throw error;

                    const totalRatings = ratings.length;
                    const averageRating = totalRatings > 0
                        ? (ratings.reduce((sum, r) => sum + r.rating, 0) / totalRatings).toFixed(1)
                        : 0;

                    this.totalRatingsEl.textContent = totalRatings;
                    this.averageRatingEl.textContent = averageRating;
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            async loadRecentActivity() {
                try {
                    const { data: activities, error } = await supabase
                        .from('ratings')
                        .select('student_id, rating, created_at')
                        .eq('user_id', this.user.id)
                        .order('created_at', { ascending: false })
                        .limit(5);

                    if (error) throw error;

                    this.activityListEl.innerHTML = activities.map(activity => `
                        <li class="activity-item">
                            <div>Rated ${activity.student_id} with ${activity.rating} stars</div>
                            <div class="activity-time">${new Date(activity.created_at).toLocaleString()}</div>
                        </li>
                    `).join('');
                } catch (error) {
                    console.error('Error loading recent activity:', error);
                }
            }

            setupRealtimeSubscription() {
                supabase
                    .channel('user_ratings')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'ratings',
                            filter: `user_id=eq.${this.user.id}`
                        }, 
                        () => {
                            this.loadUserStats();
                            this.loadRecentActivity();
                        }
                    )
                    .subscribe();
            }

            async signOut() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            }
        }
    </script>
</body>
</html> 